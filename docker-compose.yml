services:
  postgres:
    image: postgres:16
    environment:
      POSTGRES_USER: gmf
      POSTGRES_PASSWORD: gmf
      POSTGRES_DB: gmf
    ports: ["5432:5432"]
    volumes:
      - ./governance:/app/governance
      - ./ledger:/app/ledger
      - gmf_pg:/var/lib/postgresql/data

  redis:
    image: redis:7
    ports: ["6379:6379"]

  api  api  apld:
      context: .
      dockerfile: infra/api.Dockerfile
    environment:
      DATABASE_URL: postgresql+psycopg://gmf:gmf@postgres:5432/gmf
      REDIS_URL: redis://redis:6379/0
    ports: ["8000:8000"]
    depends_on: [postgres, redis]

  worker:
    build:
      context: .
      dockerfile: infra/worker.Dockerfile
    environment:
      DATABASE_URL: postgresql+psycopg://gmf:gmf@postgres:5432/gmf
      REDIS_URL: redis://redis:6379/0
    depends_on: [postgres, redis]

volumes:
  gmf_pg:


  verifier:
    environment:
      - GMF_API=http://api:8000
      - GMF_VERIFIER_ID=verifier-1
      - GMF_VERIFIER_SHARED_KEY=dev-verifier-key
      - GMF_REPLAY_MIN_VERIFIERS=2
      - GMF_REPLAY_MISMATCH_MIN=2
      - GMF_REPLAY_SAMPLE_PCT=5
      - GMF_REPLAY_SAMPLE_PCT_RISK=50
      - GMF_RISK_HALFLIFE_DAYS=7
      - GMF_RISK_PENALTY_SHARED_FINGERPRINT=8
      - GMF_RISK_PENALTY_REPLAY_MISMATCH=25
      - GMF_RISK_REWARD_GOOD_REPLAY=-1
      - GMF_RESULT_WEIGHT_MIN=0.25
      - GMF_RESULT_WEIGHT_MAX=1.0
      - GMF_REWARD_MULT_MIN=0.2
      - GMF_REWARD_MULT_MAX=1.0
      - GMF_DEVICE_CHALLENGE_TTL_SEC=300
      - GMF_HEARTBEAT_TTL_SEC=600
      - GMF_DISPATCH_REQUIRE_HEARTBEAT=true
      - GMF_DISPATCH_RISK_MAX_FOR_HEAVY=40
      - GMF_BATTERY_MIN_HEAVY=50
      - GMF_REQUIRE_CHARGING_FOR_HEAVY=false
      - GMF_ALLOW_CELLULAR_FOR_HEAVY=false
      - GMF_MIN_CPU_FOR_HEAVY=8
      - GMF_MIN_MEM_GB_FOR_HEAVY=16
      - GMF_REQUIRE_GPU_FOR_HEAVY=false
      - GMF_HEAVY_WORK_ITERS=5000000
      - GMF_HEAVY_PROOF_AUDIT_RATE=0.01
      - GMF_HEAVY_PROOF_MAX_ITERS_VERIFY=2000000
      - GMF_CREDITS_BASE_LIGHT=1
      - GMF_RULES_PATH=governance/rules/v1.json
      - GMF_RULES_SIGSET_PATH=governance/rules/v1.sigset.json
      - GMF_GUARDIAN_REGISTRY_PATH=governance/signers/registry.json
      - GMF_GUARDIAN_SET_PATH=governance/signers/guardian_set_v1.json
      - GMF_LEDGER_JSONL=ledger/receipts/receipts.jsonl
      - GMF_MERKLE_DB=ledger/cache/merkle_nodes.sqlite
      - GMF_PREWARM_BUDGET=200000
      - GMF_CHECKPOINT_PREWARM_ENABLED=1
      - GMF_CHECKPOINT_PREWARM_BUDGET=50000
      - GMF_LEDGER_CHECKPOINTS_DIR=ledger/checkpoints
      - GMF_LEDGER_PENDING_DIR=ledger/pending_checkpoints
      - GMF_CREDITS_BASE_HEAVY=5
      - GMF_CREDITS_MAX_PER_INSTANCE=200
      - GMF_CREDITS_RATE_SHA256_PER_1M=1.0
      - GMF_CREDITS_RATE_POLYMOD_PER_1M=1.5
      - GMF_RISK_CREDIT_PENALTY_PER_100=0.5
      - GMF_ANTIFARM_WINDOW_SEC=3600
      - GMF_ANTIFARM_THRESHOLD=50
      - GMF_ANTIFARM_DECAY_PER_EXTRA=0.01
      - GMF_ANTIFARM_MIN_MULT=0.2
    build:
      context: .
      dockerfile: verifier-rs/Dockerfile
    environment:
      - GMF_API=http://api:8000
      - GMF_VERIFIER_ID=verifier-1
    depends_on:
      - api

  verifier2:
    build:
      context: .
      dockerfile: verifier-rs/Dockerfile
    environment:
      - GMF_API=http://api:8000
      - GMF_VERIFIER_ID=verifier-2
      - GMF_VERIFIER_SHARED_KEY=dev-verifier-key
    depends_on:
      - api
