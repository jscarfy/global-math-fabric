services:
  postgres:
    image: postgres:16
    environment:
      POSTGRES_USER: gmf
      POSTGRES_PASSWORD: gmf
      POSTGRES_DB: gmf
    ports: ["5432:5432"]
    volumes:
      - gmf_pg:/var/lib/postgresql/data

  redis:
    image: redis:7
    ports: ["6379:6379"]

  api  api  apld:
      context: .
      dockerfile: infra/api.Dockerfile
    environment:
      DATABASE_URL: postgresql+psycopg://gmf:gmf@postgres:5432/gmf
      REDIS_URL: redis://redis:6379/0
    ports: ["8000:8000"]
    depends_on: [postgres, redis]

  worker:
    build:
      context: .
      dockerfile: infra/worker.Dockerfile
    environment:
      DATABASE_URL: postgresql+psycopg://gmf:gmf@postgres:5432/gmf
      REDIS_URL: redis://redis:6379/0
    depends_on: [postgres, redis]

volumes:
  gmf_pg:


  verifier:
    environment:
      - GMF_API=http://api:8000
      - GMF_VERIFIER_ID=verifier-1
      - GMF_VERIFIER_SHARED_KEY=dev-verifier-key
      - GMF_REPLAY_MIN_VERIFIERS=2
      - GMF_REPLAY_MISMATCH_MIN=2
      - GMF_REPLAY_SAMPLE_PCT=5
      - GMF_REPLAY_SAMPLE_PCT_RISK=50
      - GMF_RISK_HALFLIFE_DAYS=7
      - GMF_RISK_PENALTY_SHARED_FINGERPRINT=8
      - GMF_RISK_PENALTY_REPLAY_MISMATCH=25
      - GMF_RISK_REWARD_GOOD_REPLAY=-1
      - GMF_RESULT_WEIGHT_MIN=0.25
      - GMF_RESULT_WEIGHT_MAX=1.0
      - GMF_REWARD_MULT_MIN=0.2
      - GMF_REWARD_MULT_MAX=1.0
    build:
      context: .
      dockerfile: verifier-rs/Dockerfile
    environment:
      - GMF_API=http://api:8000
      - GMF_VERIFIER_ID=verifier-1
    depends_on:
      - api

  verifier2:
    build:
      context: .
      dockerfile: verifier-rs/Dockerfile
    environment:
      - GMF_API=http://api:8000
      - GMF_VERIFIER_ID=verifier-2
      - GMF_VERIFIER_SHARED_KEY=dev-verifier-key
    depends_on:
      - api
