name: release-desktop
on:
  push:
    tags:
      - 'v*'

jobs:
  linux:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: subosito/flutter-action@v2
        with:
          flutter-version: 'stable'
      - name: Decode MSIX signing cert (PFX) from GitHub Secret
        shell: bash
        env:
          MSIX_PFX_B64: ${{ secrets.MSIX_PFX_B64 }}
          MSIX_PFX_PASSWORD: ${{ secrets.MSIX_PFX_PASSWORD }}
        run: |
          mkdir -p certs
          echo "$MSIX_PFX_B64" | base64 -d > certs/gmf_ci.pfx
          echo "MSIX_PFX_PASSWORD=$MSIX_PFX_PASSWORD" >> $GITHUB_ENV

      - name: Patch msix signing fields + msix_version
        shell: bash
        run: |
          cd clients/gmf_mobile_flutter
          python3 - <<'P'
from pathlib import Path
import re, os
msix=os.environ.get('MSIX_VERSION','0.0.0.0')
p=Path('pubspec.yaml')
s=p.read_text()

def set_or_insert(key, val):
    global s
    if re.search(rf'^\s*{key}\s*:', s, flags=re.M):
        s=re.sub(rf'^\s*{key}\s*:.*$', f'  {key}: {val}', s, flags=re.M)
    else:
        s=re.sub(r'(msix_config:\s*\n)', r'\1  '+key+': '+val+'\n', s, count=1)

# msix_version (4-part)
set_or_insert('msix_version', msix)
# signing fields (CI temp file)
set_or_insert('certificate_path', '"../../certs/gmf_ci.pfx"')
set_or_insert('certificate_password', '"${MSIX_PFX_PASSWORD}"')

p.write_text(s)
print("patched msix_version/cert fields")
P

      - run: |
          cd clients/gmf_mobile_flutter
          flutter pub get
          flutter build linux --release
          mkdir -p ../../dist/updates
          tar -czf ../../dist/updates/gmf-linux-x64.tar.gz -C build/linux/x64/release/bundle .
      - uses: actions/upload-artifact@v4
        with:
          name: linux
          path: dist/updates/gmf-linux-x64.tar.gz

  windows:
    runs-on: windows-latest
    steps:
      - uses: actions/checkout@v4
      - uses: subosito/flutter-action@v2
        with:
          flutter-version: 'stable'
      - name: Patch msix_version from tag
        shell: bash
        run: |
          cd clients/gmf_mobile_flutter
          python3 - <<'P'
from pathlib import Path
import re, os
msix=os.environ.get('MSIX_VERSION','0.0.0.0')
p=Path('pubspec.yaml')
s=p.read_text()
if re.search(r'^\s*msix_version\s*:', s, flags=re.M):
    s=re.sub(r'^\s*msix_version\s*:.*$', f'  msix_version: {msix}', s, flags=re.M)
else:
    s=re.sub(r'(msix_config:\s*\n)', r"\1  msix_version: %s\n"%msix, s, count=1)
p.write_text(s)
print('msix_version set ->', msix)
P

      - run: |
          cd clients/gmf_mobile_flutter
          flutter pub get
          flutter build windows --release
          dart pub get
          dart run msix:create
          mkdir -p ../../dist/updates
          powershell -Command "Copy-Item -Force -Recurse build\windows\runner\Release\*.msix ..\..\dist\updates\gmf-windows-x64.msix"
      - uses: actions/upload-artifact
        with:
          name: windows
          path: dist/updates/gmf-windows-x64.msix

  macos:
    runs-on: macos-latest
    steps:
      - uses: actions/checkout@v4
      - uses: subosito/flutter-action@v2
        with:
          flutter-version: 'stable'
      - run: |
          cd clients/gmf_mobile_flutter
          flutter pub get
          flutter build macos --release
          mkdir -p ../../dist/updates
          ditto -c -k --sequesterRsrc --keepParent build/macos/Build/Products/Release/*.app ../../dist/updates/gmf-macos.zip
      - uses: actions/upload-artifact@v4
        with:
          name: macos
          path: dist/updates/gmf-macos.zip

  publish:
    needs: [linux, windows, macos]
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - uses: actions/download-artifact@v4
        with:
          path: dist/updates

      - name: Create GitHub Release + upload assets
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          TAG="${GITHUB_REF_NAME}"
          gh release view "$TAG" >/dev/null 2>&1 || gh release create "$TAG" -t "$TAG" -n "GMF desktop release $TAG"
          find dist/updates -type f -maxdepth 2 -print -exec gh release upload "$TAG" {} --clobber \;

      - name: Compute MSIX_VERSION from tag
        run: |
          MSIX_VERSION=$(./scripts/release/version_from_tag.sh "${GITHUB_REF_NAME}")
          echo "MSIX_VERSION=${MSIX_VERSION}" >> $GITHUB_ENV

      - name: Generate appcast.xml (Sparkle tool if present, else keep existing)
        run: |
          mkdir -p releases
          if [ -x tools/sparkle/bin/generate_appcast ]; then
            ./scripts/release/generate_appcast_sparkle.sh dist/updates releases/appcast.xml
          else
            echo "No Sparkle generate_appcast; keeping releases/appcast.xml as-is"
          fi


      - name: Update landing page from latest GitHub Release assets
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          GITHUB_REPOSITORY: ${{ github.repository }}
        run: |
          export PAGES_BASE=""  # computed inside script
          export HAVE_RELEASE=1
          export LATEST_JSON=/tmp/latest_release.json
          export ANDROID_LINK="$(grep -v '^\s*#' releases/android_play_link.txt 2>/dev/null | head -n 1 || true)"
          gh api "repos/${GITHUB_REPOSITORY}/releases/latest" > "$LATEST_JSON" || echo "{}" > "$LATEST_JSON"
          ./scripts/release/update_landing_from_latest_release.sh

      - name: Commit landing page + BuildConfig back to repo
        run: |
          git config user.name "gmf-bot"
          git config user.email "gmf-bot@users.noreply.github.com"
          git add releases/index.html clients/gmf_mobile_flutter/lib/gmf/build_config.dart || true
          git commit -m "release: refresh landing page for ${GITHUB_REF_NAME}" || true
          git push || true

      - name: Commit appcast.xml back to repo
        run: |
          git config user.name "gmf-bot"
          git config user.email "gmf-bot@users.noreply.github.com"
          git add releases/appcast.xml || true
          git commit -m "release: update appcast.xml for ${GITHUB_REF_NAME}" || true
          git push || true
